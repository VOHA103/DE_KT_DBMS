----cAU 1 :TẠO DATABASE VÀ INSERT DU LIEU


CREATE DATABASE QL_NHAHANG

USE QL_NHAHANG
GO
CREATE TABLE LOAIMON(
MALMON CHAR(10) PRIMARY KEY,
TENLOAI NVARCHAR(50)

)
GO
CREATE TABLE MONAN(
MAMON CHAR(10) PRIMARY KEY,
TENMON NVARCHAR(50),
DVT NVARCHAR(50),
DONGIA INT,
MALMON CHAR(10),
CONSTRAINT FK_MONAN FOREIGN KEY(MALMON) REFERENCES LOAIMON(MALMON)

)
GO

CREATE TABLE NGUYENLIEU(
MANLIEU CHAR(10) PRIMARY KEY,
TENNLIEU NVARCHAR(50)

)
GO


CREATE TABLE  CONGTHUC(
MAMON CHAR(10),
MANGUYENLIEU CHAR(20),
HAMLUONG INT,
CONSTRAINT PK_DH PRIMARY KEY (MAMON,MANGUYENLIEU),
CONSTRAINT FK_STDH_DH FOREIGN KEY(MAMON) REFERENCES MONAN(MAMON)

)
GO
--INSERT DATA:
INSERT INTO LOAIMON VALUES('LMON01',N'MON AN 1');
INSERT INTO LOAIMON VALUES('LMON02',N'MON AN 2');
INSERT INTO LOAIMON VALUES('LMON03',N'MON AN 3');
INSERT INTO LOAIMON VALUES('LMON04',N'MON AN 4');

INSERT INTO MONAN VALUES('MA01',N'TEN MON 1',N'DIA',100,'LMON02');
INSERT INTO MONAN VALUES('MA02',N'TEN MON 2',N'TO',200,'LMON02');
INSERT INTO MONAN VALUES('MA03',N'TEN MON 3',N'CAI',300,'LMON04');
INSERT INTO MONAN VALUES('MA04',N'TEN MON 4',N'DIA',400,'LMON01');

INSERT INTO NGUYENLIEU VALUES('MNL01',N'HANH LA');
INSERT INTO NGUYENLIEU VALUES('MNL02',N'NUOC MAM');
INSERT INTO NGUYENLIEU VALUES('MNL03',N'TOI');
INSERT INTO NGUYENLIEU VALUES('MNL04',N'DUONG');

INSERT INTO CONGTHUC VALUES('MA01','MNL02',19);
INSERT INTO CONGTHUC VALUES('MA03','MNL03',20);
INSERT INTO CONGTHUC VALUES('MA02','MNL01',12);
INSERT INTO CONGTHUC VALUES('MA04','MNL04',2);
GO
----CAU 2:
----a.	Viết thủ tục truyền vào mã món ăn, cập nhật lại đơn giá của món ăn tăng thêm 10% so với đơn giá cũ. 
--Viết lệnh thực thi thủ tục.
CREATE PROC PS_CAU2A(@MAMON CHAR(20))
AS

	BEGIN
		UPDATE MONAN
		SET DONGIA=DONGIA + DONGIA*0.1
		WHERE  MAMON=@MAMON
	END
GO
SELECT * FROM MONAN
--GOI THU TUC THUCC THI
EXEC PS_CAU2A  'MA01'

--XOA THU TUC
DROP PROC PS_CAU2A
GO
----b.	Viết hàm truyền vào mã món ăn, in ra bảng chứa thông tin các nguyên liệu làm món ăn:
---Mã nguyên liệu, tên nguyên liệu và hàm lượng. Viết lệnh gọi hàm.

CREATE FUNCTION FC_CAU2B (@MAMON CHAR(20))
RETURNS TABLE
AS
	
		RETURN (SELECT NL.MANLIEU,CT.MAMON,NL.TENNLIEU,CT.HAMLUONG
				FROM CONGTHUC CT,NGUYENLIEU NL
				WHERE  CT.MAMON=@MAMON AND NL.MANLIEU=CT.MANGUYENLIEU
				)	
GO
---GOI HAM THUC THI
SELECT*FROM dbo.FC_CAU2B ('MA01')

SELECT* FROM NGUYENLIEU
SELECT* FROM CONGTHUC

--XOA HAM 	
DROP FUNCTION dbo.FC_CAU2B 
GO
---CAU 3: SAO LUU DU LIEU vaf phuc hoi
--a.	Sao lưu cơ sở dữ liệu 


USE QL_NHAHANG
GO
--------------------
ALTER DATABASE QL_NHAHANG
SET RECOVERY FULL
--t1:full backup,tham so WITH INIT cho phep ghi de len file hien tai
BACKUP DATABASE  QL_NHAHANG 
TO DISK='E:\QL_NHAHANG_FULL.bak' 
WITH INIT
GO
--THEM 1 BANG GHI MOI
INSERT INTO LOAIMON VALUES('LMON05',N'MON AN 5');

--T2:differential backup
BACKUP DATABASE QL_NHAHANG 
 TO DISK='E:\QL_NHAHANG_DIFF.bak'
WITH INIT,DIFFERENTIAL
GO
--THEM 1 BAN GHI MOI THU 2
INSERT INTO LOAIMON VALUES('LMON06',N'MON AN 6');

--T3:transaction log backup

BACKUP LOG QL_NHAHANG 
TO DISK='E:\QL_NHAHANG_LOG.TRN' 
 WITH INIT 

GO
--THEM 1 BAN GHI THU 3
INSERT INTO LOAIMON VALUES('LMON07',N'MON AN 7');
--T4:transaction log backup

BACKUP LOG QL_NHAHANG 
TO DISK='E:\QL_NHAHANG_LOG.TRN' 
 WITH INIT 

GO
--THEM 1 BAN GHI THU 3
INSERT INTO LOAIMON VALUES('LMON08',N'MON AN 8');

--T5:TRANSACTION LOG BACKUP LAN NUA
BACKUP LOG QL_NHAHANG 
TO DISK='E:\QL_NHAHANG_LOG.TRN'
WITH NO_TRUNCATE
go
---T5:XAY RA SU CO
USE MASTER
GO
DROP DATABASE QL_NHAHANG;

--3.B:VIẾT LỆNH KHÔI PHUC SDL KHI SỰ CỐ XẢY RA Ở THỜI ĐIỂM T4,T5.

--BUOC 1: KHOI PHUC TU BANFULL BACKUP. 
RESTORE DATABASE QL_NHAHANG 
FROM DISK='E:\QL_NHAHANG_FULL.bak' 
WITH REPLACE, NORECOVERY
GO
--BUOC 2: KHOI PHUC TU BANG DIDDERENTIAL BACKUP
RESTORE DATABASE QL_NHAHANG 
FROM DISK='E:\QL_NHAHANG_DIFF.bak'
 WITH NORECOVERY
GO
--BUOC 3: KHOI PHUC TU CACS BAN TRANSACTION LOG BACKUP THEO TRINH TU THOI GIAN
RESTORE DATABASE QL_NHAHANG 
FROM DISK='E:\QL_NHAHANG_LOG.TRN' 
WITH FILE=1, NORECOVERY
GO
RESTORE DATABASE QL_NHAHANG 
FROM DISK='E:\QL_NHAHANG_LOG.TRN' 
WITH FILE=2, NORECOVERY
GO
RESTORE DATABASE QL_NHAHANG 
FROM DISK='E:\QL_NHAHANG_LOG.TRN' 
WITH FILE=3,RECOVERY,replace
GO
--KIEM TRA LAI SAU KHI KHOI PHUC
USE QL_NHAHANG
GO
SELECT*FROM LOAIMON
GO


---cau 4:
--4.a: viết lệnh tạo các tài khoản đăng nhập (login) sau:
sp_addlogin 'nhanvien1','2001190509'
go
sp_addlogin 'khachhang1','2001190508'
go
--4.b:viet lenhj tao tai khoan nguoi dug tuog ung voi tai khoang dang nhap
sp_adduser 'nhanvien1','nhanvien1'
go
sp_adduser 'khachhang1','khachhang1'
go
--4.c viet lenh tao cac nhom quyen :NHANVIEN,KHAHHANG
sp_addrole 'Nhanvien'
go
sp_addrole 'Khachhang'
go
--4.D:VIET LEHH CAP QUYE CHO CAC NHOM QUYEN SAU:
grant select,INSERT 
on NGUYENLIEU
to Nhanvien
go
  
select*from NGUYENLIEU

grant select
on MONAN
to Khachhang
go


select*from MONAN
--4.E:THU HOI QUYEN DOI VOI CAC NHOM QUYEN
REVOKE UPDATE
ON NGUYENLIEU
FROM Nhanvien



REVOKE INSERT
ON MONAN
FROM Khachhang
go
--4.F:VIET LENH NGUOI DUG VAO NHOM QUYEN 
---te nhom quye,ten guoidung
sp_droprolemember 'Nhanvien','Nhanvien1'
go
sp_droprolemember 'Khachhang','Khachhang1'
go

-----cau 5:giao tac
----P1:
BEGIN TRAN
	SET TRANSACTION ISOLATION
	LEVEL SERIALIZABLE
	SELECT*FROM NGUYENLIEU
	WAITFOR DELAY '00:00:05'

	SELECT*FROM NGUYENLIEU

COMMIT TRAN